201  [main] INFO  kkm.UnitTests - Starting test: KKM_DB6()
839  [main] INFO  kkm.UnitTests - Script is: --Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC', '2567328550', '2019-07-12 00:00:00.000', '7710026574', '0031');
--
--Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC','Фамилия Имя Отчество', '7710026574', '71000000000' );
--
--Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC', '1522756', 'INCOME');
--
--Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');
--
--insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
--select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
--from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
--where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC'
--
--
--update alertPeriod set finishTime = '00:00:00' where FilialCode = '0031'
--
--update alertPeriod set startTime = '00:00:00' where FilialCode = '0031'
--
--update fiscalCheck set filialCode = '0031' where srcId = '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC'
--
--update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC'
--




Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC', '2567328550', '2019-07-12 00:00:00.000', '7710026574', '0031');

Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC','Фамилия Имя Отчество', '7710026574', '71000000000' );

Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC', '1522756', 'INCOME');

Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');

insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC'

update alertPeriod set finishTime = '00:00:00' where FilialCode = '0031'
update alertPeriod set startTime = '00:00:00' where FilialCode = '0031'
update fiscalCheck set filialCode = '0031' where srcId = '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC'
update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC'
select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC'
91733 [main] INFO  kkm.UnitTests - select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-z0MG3CNG9kbC'
91753 [main] INFO  kkm.UnitTests - Table String info is: [ADINSURE, Payment, null, null, null, 9SD0C9DZ-9289-4A09-z0MG3CNG9kbC, null]
91760 [main] INFO  kkm.UnitTests - null
91760 [main] INFO  kkm.UnitTests - fiscGateErrorCode: null
91760 [main] INFO  kkm.UnitTests - fiscGateErrorMessage: null
121873 [main] INFO  kkm.UnitTests - URL is : http://elog.vsk.ru:9200/kkm-commutator-stage-2020.07.23/_search?q=%20message:%20%22ReadyForSendingReceiptKeys%22%20&size=5
122049 [main] INFO  kkm.UnitTests - Response message : {"took":72,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":917,"relation":"eq"},"max_score":3.6765952,"hits":[{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"GxQIeXMBfrYj4vM97FfX","_score":3.6765952,"_source":{"@timestamp":"2020-07-23T00:18:09.063Z","input":{"type":"container"},"log":{"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"},"offset":38656615},"stream":"stdout","message":"{\"ts\":\"2020-07-23T00:18:09.063+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"a3d0cf88795f37fb\",\"spanId\":\"a3d0cf88795f37fb\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"a3d0cf88795f37fb\",\"X-B3-TraceId\":\"a3d0cf88795f37fb\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","docker":{"container":{"labels":{"com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"9xQJeXMBfrYj4vM9TlqB","_score":3.6765952,"_source":{"@timestamp":"2020-07-23T00:18:31.156Z","message":"{\"ts\":\"2020-07-23T00:18:31.156+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"254ade1cd1cad981\",\"spanId\":\"254ade1cd1cad981\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"254ade1cd1cad981\",\"X-B3-TraceId\":\"254ade1cd1cad981\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","input":{"type":"container"},"host":{"name":"25805977eece"},"stream":"stdout","container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"docker":{"container":{"labels":{"com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n"}}},"ecs":{"version":"1.0.1"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38669085,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"1RQJeXMBfrYj4vM9118_","_score":3.6765952,"_source":{"@timestamp":"2020-07-23T00:19:09.042Z","stream":"stdout","message":"{\"ts\":\"2020-07-23T00:19:09.042+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"c05e2c05db6cf1bd\",\"spanId\":\"c05e2c05db6cf1bd\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"c05e2c05db6cf1bd\",\"X-B3-TraceId\":\"c05e2c05db6cf1bd\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","docker":{"container":{"labels":{"com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38699497,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"input":{"type":"container"},"container":{"name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"},"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"5xQKeXMBfrYj4vM9K2P_","_score":3.6765952,"_source":{"@timestamp":"2020-07-23T00:19:31.306Z","ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38719258,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"message":"{\"ts\":\"2020-07-23T00:19:31.306+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"6d8397303a38e7f2\",\"spanId\":\"6d8397303a38e7f2\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"6d8397303a38e7f2\",\"X-B3-TraceId\":\"6d8397303a38e7f2\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","input":{"type":"container"},"container":{"name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"},"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3"},"docker":{"container":{"labels":{"Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":""}}},"stream":"stdout"}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"ZRH9eHMBfrYj4vM9Cfe5","_score":3.6765952,"_source":{"@timestamp":"2020-07-23T00:05:09.235Z","container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"host":{"name":"25805977eece"},"log":{"offset":38121629,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"input":{"type":"container"},"docker":{"container":{"labels":{"com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service"}}},"ecs":{"version":"1.0.1"},"agent":{"id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat","ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece"},"stream":"stdout","message":"{\"ts\":\"2020-07-23T00:05:09.234+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"522e344ca449d3b8\",\"spanId\":\"522e344ca449d3b8\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"522e344ca449d3b8\",\"X-B3-TraceId\":\"522e344ca449d3b8\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}"}}]}}
122168 [main] INFO  kkm.UnitTests - Script is: update alertPeriod set finishTime = '--18:59:59--' where FilialCode = '0031'
update alertPeriod set startTime = '--09:00:00--' where FilialCode = '0031'
122210 [main] INFO  kkm.UnitTests - End test

122221 [main] INFO  kkm.UnitTests - Starting test: KKM_DB1()
122382 [main] INFO  kkm.UnitTests - Script is: SELECT TOP 1 * FROM ProcessStatus Where fiscGateCheckStatusCode = 'ERROR'
122383 [main] INFO  kkm.UnitTests - srcID is: ЖПлато_000898622
122388 [main] INFO  kkm.UnitTests - srcID is: ЖПлато_000898622
122804 [main] INFO  kkm.UnitTests - update dbo.Customer set inn = '1' where srcID = 'ЖПлато_000898622'
update ProcessStatus set fiscGateCheckStatusCode = null where srcID = 'ЖПлато_000898622'
select * from ProcessStatus where srcID = 'ЖПлато_000898622'
122806 [main] INFO  kkm.UnitTests - Table String info is: [AXAPTA, PaymentOrder, null, VALIDATION_ERROR, ЖПлато_000898622]
122810 [main] INFO  kkm.UnitTests - Status is: [AXAPTA, PaymentOrder, null, VALIDATION_ERROR, ЖПлато_000898622]
183063 [main] INFO  kkm.UnitTests - select * from ProcessStatus where srcID = 'ЖПлато_000898622'
183064 [main] INFO  kkm.UnitTests - Table String info is: [AXAPTA, PaymentOrder, ERROR, VALIDATION_ERROR, ЖПлато_000898622]
243065 [main] INFO  kkm.UnitTests - URL is : http://elog.vsk.ru:9200/kkm-commutator-stage-2020.07.23/_search?q=%20message:%20%22ReadyForSendingReceiptKeys%22%20AND%20%22ЖПлато_000898622%22%20&size=500
243269 [main] INFO  kkm.UnitTests - Response message : {"took":127,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":6,"relation":"eq"},"max_score":11.089457,"hits":[{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"j2A8enMBfrYj4vM9702F","_score":11.089457,"_source":{"@timestamp":"2020-07-23T05:54:31.167Z","stream":"stdout","message":"{\"ts\":\"2020-07-23T05:54:31.166+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"395a2227ed200ae0\",\"spanId\":\"395a2227ed200ae0\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"395a2227ed200ae0\",\"X-B3-TraceId\":\"395a2227ed200ae0\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898622\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","input":{"type":"container"},"log":{"offset":2417433,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"docker":{"container":{"labels":{"com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida"}}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"0GVUenMBfrYj4vM9WAlo","_score":11.089457,"_source":{"@timestamp":"2020-07-23T06:20:09.258Z","message":"{\"ts\":\"2020-07-23T06:20:09.258+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"248108560dcf49e1\",\"spanId\":\"248108560dcf49e1\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"248108560dcf49e1\",\"X-B3-TraceId\":\"248108560dcf49e1\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898622\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","input":{"type":"container"},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"agent":{"id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat","ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece"},"log":{"offset":3548698,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"docker":{"container":{"labels":{"com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"host":{"name":"25805977eece"},"stream":"stdout"}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"ImlienMBfrYj4vM9_xQn","_score":11.089457,"_source":{"@timestamp":"2020-07-23T06:36:09.180Z","input":{"type":"container"},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":6020810,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"stream":"stdout","message":"{\"ts\":\"2020-07-23T06:36:09.180+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"389a0caac1fdc697\",\"spanId\":\"389a0caac1fdc697\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"389a0caac1fdc697\",\"X-B3-TraceId\":\"389a0caac1fdc697\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898622\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","docker":{"container":{"labels":{"com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"ecs":{"version":"1.0.1"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"0XB5enMBfrYj4vM9ELNJ","_score":11.089457,"_source":{"@timestamp":"2020-07-23T07:00:09.474Z","host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":7252349,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"stream":"stdout","input":{"type":"container"},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"message":"{\"ts\":\"2020-07-23T07:00:09.473+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"2210badf387d4ed9\",\"spanId\":\"2210badf387d4ed9\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"2210badf387d4ed9\",\"X-B3-TraceId\":\"2210badf387d4ed9\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898622\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","docker":{"container":{"labels":{"com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"aG91enMBfrYj4vM9sIXl","_score":11.089457,"_source":{"@timestamp":"2020-07-23T06:56:31.155Z","log":{"offset":7081098,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"stream":"stdout","input":{"type":"container"},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"message":"{\"ts\":\"2020-07-23T06:56:31.155+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"f64123dd619c08f8\",\"spanId\":\"f64123dd619c08f8\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"f64123dd619c08f8\",\"X-B3-TraceId\":\"f64123dd619c08f8\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898622\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","docker":{"container":{"labels":{"com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"x32denMBfrYj4vM9EDhB","_score":11.089457,"_source":{"@timestamp":"2020-07-23T07:39:31.141Z","log":{"offset":9107785,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"stream":"stdout","message":"{\"ts\":\"2020-07-23T07:39:31.140+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"e4bae1c51de28841\",\"spanId\":\"e4bae1c51de28841\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"e4bae1c51de28841\",\"X-B3-TraceId\":\"e4bae1c51de28841\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898622\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","input":{"type":"container"},"docker":{"container":{"labels":{"com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service"}}}}}]}}
243271 [main] INFO  kkm.UnitTests - End test

243275 [main] INFO  kkm.UnitTests - Starting test: KKM_DB8()
243398 [main] INFO  kkm.UnitTests - Script is: --Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-CLGYEodhJNBy', '1433904795', '2019-07-12 00:00:00.000', '7710026574', 'NOFILIAL');
--
--Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-CLGYEodhJNBy','Фамилия Имя Отчество', '7710026574', '71000000000' );
--
--Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-CLGYEodhJNBy', '1522756', 'INCOME');
--
--Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-CLGYEodhJNBy', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');
--
--insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
--select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
--from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
--where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-CLGYEodhJNBy'
--
--
--update alertPeriod set finishTime = '00:00:00' where FilialCode = 'NOFILIAL'
--
--update alertPeriod set startTime = '00:00:00' where FilialCode = 'NOFILIAL'
--
--update fiscalCheck set filialCode = 'NOFILIAL' where srcId = '9SD0C9DZ-9289-4A09-CLGYEodhJNBy'
--
--update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-CLGYEodhJNBy'
--




Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-CLGYEodhJNBy', '1433904795', '2019-07-12 00:00:00.000', '7710026574', 'NOFILIAL');

Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-CLGYEodhJNBy','Фамилия Имя Отчество', '7710026574', '71000000000' );

Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-CLGYEodhJNBy', '1522756', 'INCOME');

Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-CLGYEodhJNBy', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');

insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-CLGYEodhJNBy'

update alertPeriod set finishTime = '00:00:00' where FilialCode = 'NOFILIAL'
update alertPeriod set startTime = '00:00:00' where FilialCode = 'NOFILIAL'
update fiscalCheck set filialCode = 'NOFILIAL' where srcId = '9SD0C9DZ-9289-4A09-CLGYEodhJNBy'
update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-CLGYEodhJNBy'
select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-CLGYEodhJNBy'
334039 [main] INFO  kkm.UnitTests - select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-CLGYEodhJNBy'
334039 [main] INFO  kkm.UnitTests - Table String info is: [ADINSURE, Payment, null, null, null, 9SD0C9DZ-9289-4A09-CLGYEodhJNBy, null]
334040 [main] INFO  kkm.UnitTests - null
334041 [main] INFO  kkm.UnitTests - fiscGateErrorCode: null
334041 [main] INFO  kkm.UnitTests - fiscGateErrorMessage: null
364042 [main] INFO  kkm.UnitTests - URL is : http://elog.vsk.ru:9200/kkm-commutator-stage-2020.07.23/_search?q=%20message:%20%22ReadyForSendingReceiptKeys%22%20&size=5
364108 [main] INFO  kkm.UnitTests - Response message : {"took":10,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":925,"relation":"eq"},"max_score":3.6766667,"hits":[{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"GxQIeXMBfrYj4vM97FfX","_score":3.6766667,"_source":{"@timestamp":"2020-07-23T00:18:09.063Z","input":{"type":"container"},"log":{"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"},"offset":38656615},"stream":"stdout","message":"{\"ts\":\"2020-07-23T00:18:09.063+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"a3d0cf88795f37fb\",\"spanId\":\"a3d0cf88795f37fb\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"a3d0cf88795f37fb\",\"X-B3-TraceId\":\"a3d0cf88795f37fb\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","docker":{"container":{"labels":{"com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"9xQJeXMBfrYj4vM9TlqB","_score":3.6766667,"_source":{"@timestamp":"2020-07-23T00:18:31.156Z","message":"{\"ts\":\"2020-07-23T00:18:31.156+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"254ade1cd1cad981\",\"spanId\":\"254ade1cd1cad981\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"254ade1cd1cad981\",\"X-B3-TraceId\":\"254ade1cd1cad981\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","input":{"type":"container"},"host":{"name":"25805977eece"},"stream":"stdout","container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"docker":{"container":{"labels":{"com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n"}}},"ecs":{"version":"1.0.1"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38669085,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"1RQJeXMBfrYj4vM9118_","_score":3.6766667,"_source":{"@timestamp":"2020-07-23T00:19:09.042Z","stream":"stdout","message":"{\"ts\":\"2020-07-23T00:19:09.042+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"c05e2c05db6cf1bd\",\"spanId\":\"c05e2c05db6cf1bd\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"c05e2c05db6cf1bd\",\"X-B3-TraceId\":\"c05e2c05db6cf1bd\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","docker":{"container":{"labels":{"com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38699497,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"input":{"type":"container"},"container":{"name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"},"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"5xQKeXMBfrYj4vM9K2P_","_score":3.6766667,"_source":{"@timestamp":"2020-07-23T00:19:31.306Z","ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38719258,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"message":"{\"ts\":\"2020-07-23T00:19:31.306+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"6d8397303a38e7f2\",\"spanId\":\"6d8397303a38e7f2\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"6d8397303a38e7f2\",\"X-B3-TraceId\":\"6d8397303a38e7f2\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","input":{"type":"container"},"container":{"name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"},"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3"},"docker":{"container":{"labels":{"Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":""}}},"stream":"stdout"}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"ZRH9eHMBfrYj4vM9Cfe5","_score":3.6766667,"_source":{"@timestamp":"2020-07-23T00:05:09.235Z","container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"host":{"name":"25805977eece"},"log":{"offset":38121629,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"input":{"type":"container"},"docker":{"container":{"labels":{"com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service"}}},"ecs":{"version":"1.0.1"},"agent":{"id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat","ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece"},"stream":"stdout","message":"{\"ts\":\"2020-07-23T00:05:09.234+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"522e344ca449d3b8\",\"spanId\":\"522e344ca449d3b8\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"522e344ca449d3b8\",\"X-B3-TraceId\":\"522e344ca449d3b8\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}"}}]}}
364254 [main] INFO  kkm.UnitTests - Script is: update alertPeriod set finishTime = '--18:59:59--' where FilialCode = 'NOFILIAL'
update alertPeriod set startTime = '--09:00:00--' where FilialCode = 'NOFILIAL'
364282 [main] INFO  kkm.UnitTests - End test

364286 [main] INFO  kkm.UnitTests - Starting test: KKM_DB3()
364434 [main] INFO  kkm.UnitTests - Script is: --Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw', '6184004614', '2019-07-12 00:00:00.000', '7710026574', '0031');
--
--Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw','Фамилия Имя Отчество', '7710026574', '71000000000' );
--
--Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw', '1522756', 'INCOME');
--
--Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');
--
--insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
--select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
--from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
--where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw'
--
--
--update alertPeriod set finishTime = '23:59:59' where FilialCode = '0031'
--
--update alertPeriod set startTime = '00:00:00' where FilialCode = '0031'
--
--update fiscalCheck set filialCode = '0031' where srcId = '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw'
--
--update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw'
--




Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw', '6184004614', '2019-07-12 00:00:00.000', '7710026574', '0031');

Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw','Фамилия Имя Отчество', '7710026574', '71000000000' );

Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw', '1522756', 'INCOME');

Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');

insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw'

update alertPeriod set finishTime = '23:59:59' where FilialCode = '0031'
update alertPeriod set startTime = '00:00:00' where FilialCode = '0031'
update fiscalCheck set filialCode = '0031' where srcId = '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw'
update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw'
select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw'
455082 [main] INFO  kkm.UnitTests - select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-1xlEKqqFhNDw'
455083 [main] INFO  kkm.UnitTests - Table String info is: [ADINSURE, Payment, DONE, , , 9SD0C9DZ-9289-4A09-1xlEKqqFhNDw, efae0cc4-e059-4fee-a732-02ac03ace390]
455086 [main] INFO  kkm.UnitTests - DONE
455086 [main] INFO  kkm.UnitTests - fiscGateErrorCode: 
455086 [main] INFO  kkm.UnitTests - fiscGateErrorMessage: 
485267 [main] INFO  kkm.UnitTests - URL is : http://elog.vsk.ru:9200/kkm-commutator-stage-2020.07.23/_search?q=%20message:%20%22ReadyForSendingReceiptKeys%22%20AND%20%229SD0C9DZ-9289-4A09-1xlEKqqFhNDw%22%20&size=500
485375 [main] INFO  kkm.UnitTests - Response message : {"took":26,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":1,"relation":"eq"},"max_score":23.814985,"hits":[{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"M3-genMBfrYj4vM9xVWU","_score":23.814985,"_source":{"@timestamp":"2020-07-23T07:43:31.144Z","docker":{"container":{"labels":{"com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"log":{"offset":9295062,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"input":{"type":"container"},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"stream":"stdout","message":"{\"ts\":\"2020-07-23T07:43:31.144+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"0bd8338d70509a0d\",\"spanId\":\"0bd8338d70509a0d\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"0bd8338d70509a0d\",\"X-B3-TraceId\":\"0bd8338d70509a0d\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"ADINSURE\",\"entityCode\":\"Payment\",\"srcID\":\"9SD0C9DZ-9289-4A09-1xlEKqqFhNDw\"},{\"systemCode\":\"ADINSURE\",\"entityCode\":\"Payment\",\"srcID\":\"9SD0C9DZ-9289-4A09-z0MG3CNG9kbC\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}"}}]}}
485882 [main] INFO  kkm.UnitTests - Script is: update alertPeriod set finishTime = '--18:59:59--' where FilialCode = '0031'
update alertPeriod set startTime = '--09:00:00--' where FilialCode = '0031'
485907 [main] INFO  kkm.UnitTests - End test

485912 [main] INFO  kkm.UnitTests - Starting test: KKM_DB4()
486049 [main] INFO  kkm.UnitTests - Script is: --Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-UPLFZifUOJK1', '9839031055', '2019-07-12 00:00:00.000', '7725327863', '0067');
--
--Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-UPLFZifUOJK1','Фамилия Имя Отчество', '7725327863', '71000000000' );
--
--Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-UPLFZifUOJK1', '1522756', 'INCOME');
--
--Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-UPLFZifUOJK1', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');
--
--insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
--select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
--from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
--where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-UPLFZifUOJK1'
--
--
--update alertPeriod set finishTime = '23:59:59' where FilialCode = '0067'
--
--update alertPeriod set startTime = '00:00:00' where FilialCode = '0067'
--
--update fiscalCheck set filialCode = '0067' where srcId = '9SD0C9DZ-9289-4A09-UPLFZifUOJK1'
--
--update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-UPLFZifUOJK1'
--




Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-UPLFZifUOJK1', '9839031055', '2019-07-12 00:00:00.000', '7725327863', '0067');

Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-UPLFZifUOJK1','Фамилия Имя Отчество', '7725327863', '71000000000' );

Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-UPLFZifUOJK1', '1522756', 'INCOME');

Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-UPLFZifUOJK1', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');

insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-UPLFZifUOJK1'

update alertPeriod set finishTime = '23:59:59' where FilialCode = '0067'
update alertPeriod set startTime = '00:00:00' where FilialCode = '0067'
update fiscalCheck set filialCode = '0067' where srcId = '9SD0C9DZ-9289-4A09-UPLFZifUOJK1'
update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-UPLFZifUOJK1'
select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-UPLFZifUOJK1'
576659 [main] INFO  kkm.UnitTests - select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-UPLFZifUOJK1'
576660 [main] INFO  kkm.UnitTests - Table String info is: [ADINSURE, Payment, FAIL, BAD_REQUEST, Bad request: {
  "errors": [
    "Передача данных автомата недоступна для указанной группы"
  ]
}, 9SD0C9DZ-9289-4A09-UPLFZifUOJK1, 779857b3-198f-4aa2-8ca3-730609b46244]
576663 [main] INFO  kkm.UnitTests - FAIL
576664 [main] INFO  kkm.UnitTests - fiscGateErrorCode: BAD_REQUEST
576664 [main] INFO  kkm.UnitTests - fiscGateErrorMessage: Bad request: {
  "errors": [
    "Передача данных автомата недоступна для указанной группы"
  ]
}
606764 [main] INFO  kkm.UnitTests - URL is : http://elog.vsk.ru:9200/kkm-commutator-stage-2020.07.23/_search?q=%20message:%20%22ReadyForSendingReceiptKeys%22%20AND%20%229SD0C9DZ-9289-4A09-UPLFZifUOJK1%22%20&size=500
606833 [main] INFO  kkm.UnitTests - Response message : {"took":18,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":1,"relation":"eq"},"max_score":23.76409,"hits":[{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"DX-ienMBfrYj4vM9f88P","_score":23.76409,"_source":{"@timestamp":"2020-07-23T07:45:31.312Z","ecs":{"version":"1.0.1"},"log":{"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"},"offset":9436352},"input":{"type":"container"},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"stream":"stdout","message":"{\"ts\":\"2020-07-23T07:45:31.312+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"2f1117b3732b4644\",\"spanId\":\"2f1117b3732b4644\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"2f1117b3732b4644\",\"X-B3-TraceId\":\"2f1117b3732b4644\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"ADINSURE\",\"entityCode\":\"Payment\",\"srcID\":\"9SD0C9DZ-9289-4A09-UPLFZifUOJK1\"},{\"systemCode\":\"ADINSURE\",\"entityCode\":\"Payment\",\"srcID\":\"9SD0C9DZ-9289-4A09-ZN5ROdocekNT\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","docker":{"container":{"labels":{"com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"host":{"name":"25805977eece"}}}]}}
606955 [main] INFO  kkm.UnitTests - Script is: update alertPeriod set finishTime = '--18:59:59--' where FilialCode = '0067'
update alertPeriod set startTime = '--09:00:00--' where FilialCode = '0067'
606980 [main] INFO  kkm.UnitTests - End test

606984 [main] INFO  kkm.UnitTests - Starting test: KKM_DB2()
607138 [main] INFO  kkm.UnitTests - Script is: SELECT TOP 1 * FROM ProcessStatus Where fiscGateCheckStatusCode = 'DONE'
607138 [main] INFO  kkm.UnitTests - srcID is: ЖПлато_000898541
607142 [main] INFO  kkm.UnitTests - srcID is: ЖПлато_000898541
607617 [main] INFO  kkm.UnitTests - update alertPeriod set finishTime = '00:00:00' where FilialCode = '--filialCode--'
update alertPeriod set startTime = '00:00:00' where FilialCode = '--filialCode--'
update customer set Phone = '70000000000' where srcID = 'ЖПлато_000898541'
update customer set email = '' where srcId = 'ЖПлато_000898541'
update processStatus set fiscGateCheckStatusCode = null where srcID = 'ЖПлато_000898541'
select * from processStatus where srcID = 'ЖПлато_000898541'
607618 [main] INFO  kkm.UnitTests - Table String info is: [AXAPTA, PaymentOrder, null, nothing, ЖПлато_000898541]
607621 [main] INFO  kkm.UnitTests - Status is: [AXAPTA, PaymentOrder, null, nothing, ЖПлато_000898541]
667860 [main] INFO  kkm.UnitTests - select * from ProcessStatus where srcID = 'ЖПлато_000898541'
667861 [main] INFO  kkm.UnitTests - Table String info is: [AXAPTA, PaymentOrder, DONE, nothing, ЖПлато_000898541]
727868 [main] INFO  kkm.UnitTests - URL is : http://elog.vsk.ru:9200/kkm-commutator-stage-2020.07.23/_search?q=%20message:%20%22ReadyForSendingReceiptKeys%22%20AND%20%22ЖПлато_000898541%22%20&size=500
728041 [main] INFO  kkm.UnitTests - Response message : {"took":117,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":5,"relation":"eq"},"max_score":10.423676,"hits":[{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"LGFCenMBfrYj4vM99nSn","_score":10.423676,"_source":{"@timestamp":"2020-07-23T06:01:09.393Z","stream":"stdout","input":{"type":"container"},"ecs":{"version":"1.0.1"},"log":{"offset":2735196,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"message":"{\"ts\":\"2020-07-23T06:01:09.392+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"d3cb5b1ffc272cb0\",\"spanId\":\"d3cb5b1ffc272cb0\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"d3cb5b1ffc272cb0\",\"X-B3-TraceId\":\"d3cb5b1ffc272cb0\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898541\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"docker":{"container":{"labels":{"com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida"}}},"host":{"name":"25805977eece"},"agent":{"id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat","ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"AWZaenMBfrYj4vM9QL-Y","_score":10.423676,"_source":{"@timestamp":"2020-07-23T06:26:31.160Z","stream":"stdout","log":{"offset":5430786,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"input":{"type":"container"},"docker":{"container":{"labels":{"com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"agent":{"version":"7.3.1","type":"filebeat","ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876"},"message":"{\"ts\":\"2020-07-23T06:26:31.159+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"a15f354a1688d0fa\",\"spanId\":\"a15f354a1688d0fa\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"a15f354a1688d0fa\",\"X-B3-TraceId\":\"a15f354a1688d0fa\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898541\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"qmtqenMBfrYj4vM9Umdo","_score":10.423676,"_source":{"@timestamp":"2020-07-23T06:44:09.197Z","stream":"stdout","message":"{\"ts\":\"2020-07-23T06:44:09.197+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"25c2d78b48d92cac\",\"spanId\":\"25c2d78b48d92cac\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"25c2d78b48d92cac\",\"X-B3-TraceId\":\"25c2d78b48d92cac\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898541\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","input":{"type":"container"},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"agent":{"type":"filebeat","ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1"},"log":{"offset":6489267,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"docker":{"container":{"labels":{"com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida"}}},"host":{"name":"25805977eece"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"U3SAenMBfrYj4vM9rTHC","_score":10.423676,"_source":{"@timestamp":"2020-07-23T07:08:31.142Z","ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"message":"{\"ts\":\"2020-07-23T07:08:31.142+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"8bbf3ee482db6ee7\",\"spanId\":\"8bbf3ee482db6ee7\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"8bbf3ee482db6ee7\",\"X-B3-TraceId\":\"8bbf3ee482db6ee7\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898541\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","input":{"type":"container"},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"docker":{"container":{"labels":{"com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":7758240,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"stream":"stdout"}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"AoCkenMBfrYj4vM9Wzmu","_score":10.423676,"_source":{"@timestamp":"2020-07-23T07:47:31.134Z","log":{"offset":9584810,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"stream":"stdout","message":"{\"ts\":\"2020-07-23T07:47:31.134+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"208e8e39fd7fc1e1\",\"spanId\":\"208e8e39fd7fc1e1\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"208e8e39fd7fc1e1\",\"X-B3-TraceId\":\"208e8e39fd7fc1e1\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"AXAPTA\",\"entityCode\":\"PaymentOrder\",\"srcID\":\"ЖПлато_000898541\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","input":{"type":"container"},"docker":{"container":{"labels":{"com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"}}}]}}
728043 [main] INFO  kkm.UnitTests - End test

728045 [main] INFO  kkm.UnitTests - Starting test: KKM_DB5()
728172 [main] INFO  kkm.UnitTests - Script is: --Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ', '0026261219', '2019-07-12 00:00:00.000', '7710026574', 'NOFILIAL');
--
--Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ','Фамилия Имя Отчество', '7710026574', '71000000000' );
--
--Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ', '1522756', 'INCOME');
--
--Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');
--
--insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
--select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
--from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
--where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ'
--
--
--update alertPeriod set finishTime = '23:59:59' where FilialCode = 'NOFILIAL'
--
--update alertPeriod set startTime = '00:00:00' where FilialCode = 'NOFILIAL'
--
--update fiscalCheck set filialCode = 'NOFILIAL' where srcId = '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ'
--
--update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ'
--




Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ', '0026261219', '2019-07-12 00:00:00.000', '7710026574', 'NOFILIAL');

Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ','Фамилия Имя Отчество', '7710026574', '71000000000' );

Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ', '1522756', 'INCOME');

Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');

insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ'

update alertPeriod set finishTime = '23:59:59' where FilialCode = 'NOFILIAL'
update alertPeriod set startTime = '00:00:00' where FilialCode = 'NOFILIAL'
update fiscalCheck set filialCode = 'NOFILIAL' where srcId = '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ'
update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ'
select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ'
818887 [main] INFO  kkm.UnitTests - select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ'
818887 [main] INFO  kkm.UnitTests - Table String info is: [ADINSURE, Payment, DONE, , , 9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ, 9be7be18-eb8f-434e-b105-a23768ec2d44]
818891 [main] INFO  kkm.UnitTests - DONE
818891 [main] INFO  kkm.UnitTests - fiscGateErrorCode: 
818891 [main] INFO  kkm.UnitTests - fiscGateErrorMessage: 
849000 [main] INFO  kkm.UnitTests - URL is : http://elog.vsk.ru:9200/kkm-commutator-stage-2020.07.23/_search?q=%20message:%20%22ReadyForSendingReceiptKeys%22%20AND%20%229SD0C9DZ-9289-4A09-O0UhZhUU9TLZ%22%20&size=500
849087 [main] INFO  kkm.UnitTests - Response message : {"took":32,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":1,"relation":"eq"},"max_score":23.732855,"hits":[{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"aoGmenMBfrYj4vM9OEVN","_score":23.732855,"_source":{"@timestamp":"2020-07-23T07:49:31.141Z","log":{"offset":9694808,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"stream":"stdout","container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"message":"{\"ts\":\"2020-07-23T07:49:31.141+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":84,\"thread\":\"scheduling-1\",\"traceId\":\"63d665dd04c68a9a\",\"spanId\":\"63d665dd04c68a9a\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"63d665dd04c68a9a\",\"X-B3-TraceId\":\"63d665dd04c68a9a\",\"X-VSK-ReceiptKeys\":[{\"systemCode\":\"ADINSURE\",\"entityCode\":\"Payment\",\"srcID\":\"9SD0C9DZ-9289-4A09-O0UhZhUU9TLZ\"},{\"systemCode\":\"ADINSURE\",\"entityCode\":\"Payment\",\"srcID\":\"9SD0C9DZ-9289-4A09-CLGYEodhJNBy\"}],\"msg\":\"ReadyForSendingReceiptKeys selected \"}","input":{"type":"container"},"docker":{"container":{"labels":{"Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}}}}]}}
849237 [main] INFO  kkm.UnitTests - Script is: update alertPeriod set finishTime = '--18:59:59--' where FilialCode = 'NOFILIAL'
update alertPeriod set startTime = '--09:00:00--' where FilialCode = 'NOFILIAL'
849262 [main] INFO  kkm.UnitTests - End test

849265 [main] INFO  kkm.UnitTests - Starting test: KKM_DB7()
849405 [main] INFO  kkm.UnitTests - Script is: --Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-4KCmgx8a34g9', '3094899404', '2019-07-12 00:00:00.000', '7725327863', '0067');
--
--Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-4KCmgx8a34g9','Фамилия Имя Отчество', '7725327863', '71000000000' );
--
--Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-4KCmgx8a34g9', '1522756', 'INCOME');
--
--Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
--values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-4KCmgx8a34g9', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');
--
--insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
--select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
--from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
--where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-4KCmgx8a34g9'
--
--
--update alertPeriod set finishTime = '00:00:00' where FilialCode = '0067'
--
--update alertPeriod set startTime = '00:00:00' where FilialCode = '0067'
--
--update fiscalCheck set filialCode = '0067' where srcId = '9SD0C9DZ-9289-4A09-4KCmgx8a34g9'
--
--update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-4KCmgx8a34g9'
--




Insert into FiscalCheck(SystemCode,EntityCode,srcID,CorrelationID,Date,OrganizationInn, FilialCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-4KCmgx8a34g9', '3094899404', '2019-07-12 00:00:00.000', '7725327863', '0067');

Insert into Customer(SystemCode,EntityCode,srcID, FullName,INN, Phone)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-4KCmgx8a34g9','Фамилия Имя Отчество', '7725327863', '71000000000' );

Insert into Payment(SystemCode,EntityCode,srcID,Amount,PaymentTypeCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-4KCmgx8a34g9', '1522756', 'INCOME');

Insert into Position(SystemCode,EntityCode,srcID,"Number",Name,Price,Quantity,TaxCode)
values( 'ADINSURE', 'Payment', '9SD0C9DZ-9289-4A09-4KCmgx8a34g9', '123456', 'Страховая премия № 100000000', '1234', '1234', 'VAT20');

insert into ProcessStatus(SystemCode, EntityCode, srcID, fiscGateCorrelationID)
select top 1 f.SystemCode, f.EntityCode, f.srcID, CorrelationID
from FiscalCheck as f left join ProcessStatus as p on p.SystemCode = f.SystemCode and p.EntityCode = f.EntityCode and p.srcID = f.srcID
where p.EntityCode is null and f.srcID = '9SD0C9DZ-9289-4A09-4KCmgx8a34g9'

update alertPeriod set finishTime = '00:00:00' where FilialCode = '0067'
update alertPeriod set startTime = '00:00:00' where FilialCode = '0067'
update fiscalCheck set filialCode = '0067' where srcId = '9SD0C9DZ-9289-4A09-4KCmgx8a34g9'
update processStatus set fiscGateCheckStatusCode = null where srcId = '9SD0C9DZ-9289-4A09-4KCmgx8a34g9'
select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-4KCmgx8a34g9'
940066 [main] INFO  kkm.UnitTests - select * from processStatus where srcID = '9SD0C9DZ-9289-4A09-4KCmgx8a34g9'
940067 [main] INFO  kkm.UnitTests - Table String info is: [ADINSURE, Payment, null, null, null, 9SD0C9DZ-9289-4A09-4KCmgx8a34g9, null]
940070 [main] INFO  kkm.UnitTests - null
940071 [main] INFO  kkm.UnitTests - fiscGateErrorCode: null
940071 [main] INFO  kkm.UnitTests - fiscGateErrorMessage: null
970075 [main] INFO  kkm.UnitTests - URL is : http://elog.vsk.ru:9200/kkm-commutator-stage-2020.07.23/_search?q=%20message:%20%22ReadyForSendingReceiptKeys%22%20&size=5
970180 [main] INFO  kkm.UnitTests - Response message : {"took":50,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":945,"relation":"eq"},"max_score":3.6855905,"hits":[{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"GxQIeXMBfrYj4vM97FfX","_score":3.6855905,"_source":{"@timestamp":"2020-07-23T00:18:09.063Z","input":{"type":"container"},"log":{"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"},"offset":38656615},"stream":"stdout","message":"{\"ts\":\"2020-07-23T00:18:09.063+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"a3d0cf88795f37fb\",\"spanId\":\"a3d0cf88795f37fb\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"a3d0cf88795f37fb\",\"X-B3-TraceId\":\"a3d0cf88795f37fb\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","docker":{"container":{"labels":{"com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"9xQJeXMBfrYj4vM9TlqB","_score":3.6855905,"_source":{"@timestamp":"2020-07-23T00:18:31.156Z","message":"{\"ts\":\"2020-07-23T00:18:31.156+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"254ade1cd1cad981\",\"spanId\":\"254ade1cd1cad981\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"254ade1cd1cad981\",\"X-B3-TraceId\":\"254ade1cd1cad981\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","input":{"type":"container"},"host":{"name":"25805977eece"},"stream":"stdout","container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"docker":{"container":{"labels":{"com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n"}}},"ecs":{"version":"1.0.1"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38669085,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"1RQJeXMBfrYj4vM9118_","_score":3.6855905,"_source":{"@timestamp":"2020-07-23T00:19:09.042Z","stream":"stdout","message":"{\"ts\":\"2020-07-23T00:19:09.042+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"c05e2c05db6cf1bd\",\"spanId\":\"c05e2c05db6cf1bd\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"c05e2c05db6cf1bd\",\"X-B3-TraceId\":\"c05e2c05db6cf1bd\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","docker":{"container":{"labels":{"com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service","Version":"97","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida"}}},"ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38699497,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"input":{"type":"container"},"container":{"name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"},"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3"}}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"5xQKeXMBfrYj4vM9K2P_","_score":3.6855905,"_source":{"@timestamp":"2020-07-23T00:19:31.306Z","ecs":{"version":"1.0.1"},"host":{"name":"25805977eece"},"agent":{"ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece","id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat"},"log":{"offset":38719258,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"message":"{\"ts\":\"2020-07-23T00:19:31.306+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"6d8397303a38e7f2\",\"spanId\":\"6d8397303a38e7f2\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"6d8397303a38e7f2\",\"X-B3-TraceId\":\"6d8397303a38e7f2\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}","input":{"type":"container"},"container":{"name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"},"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3"},"docker":{"container":{"labels":{"Description":"KKM Commutator Service","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":""}}},"stream":"stdout"}},{"_index":"kkm-commutator-stage-2020.07.23","_type":"_doc","_id":"ZRH9eHMBfrYj4vM9Cfe5","_score":3.6855905,"_source":{"@timestamp":"2020-07-23T00:05:09.235Z","container":{"id":"8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3","name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","image":{"name":"nexus.vsk.ru:8183/vsk/kkm-commutator:97@sha256:d7fe200be876de577493ecaf034656903ed1743d311447433a9e080df2bf87fe"}},"host":{"name":"25805977eece"},"log":{"offset":38121629,"file":{"path":"/var/lib/docker/containers/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3/8acdbd0e1f6da341879ba61aee84362cfeb386a81e0889176ea90009cea717a3-json.log"}},"input":{"type":"container"},"docker":{"container":{"labels":{"com_docker_stack_namespace":"kkm-commutator","com_docker_swarm_task":"","com_docker_swarm_task_name":"kkm-commutator_service.1.eqt37is64rgqgyp486kpbqida","Version":"97","com_docker_swarm_node_id":"ygqa2daq7eosrz5hy95q8qotd","com_docker_swarm_task_id":"eqt37is64rgqgyp486kpbqida","com_docker_swarm_service_id":"vzf1p3l7jfjimzgsk4k4shq6n","com_docker_swarm_service_name":"kkm-commutator_service","Description":"KKM Commutator Service"}}},"ecs":{"version":"1.0.1"},"agent":{"id":"b42b3136-a942-47e4-a9fc-eaddc4fbe876","version":"7.3.1","type":"filebeat","ephemeral_id":"d557a4cf-a231-4f25-a77d-53dd56bac792","hostname":"25805977eece"},"stream":"stdout","message":"{\"ts\":\"2020-07-23T00:05:09.234+00:00\",\"logger\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"level\":\"INFO\",\"class\":\"ru.vsk.integration.kkmcommutator.KkmCommutatorService\",\"method\":\"getReadyForSendingReceiptKeys\",\"caller_file_name\":\"KkmCommutatorService.java\",\"caller_line_number\":82,\"thread\":\"scheduling-1\",\"traceId\":\"522e344ca449d3b8\",\"spanId\":\"522e344ca449d3b8\",\"spanExportable\":\"true\",\"X-Span-Export\":\"true\",\"X-B3-SpanId\":\"522e344ca449d3b8\",\"X-B3-TraceId\":\"522e344ca449d3b8\",\"msg\":\"ReadyForSendingReceiptKeys is EMPTY\"}"}}]}}
970313 [main] INFO  kkm.UnitTests - Script is: update alertPeriod set finishTime = '--18:59:59--' where FilialCode = '0067'
update alertPeriod set startTime = '--09:00:00--' where FilialCode = '0067'
970336 [main] INFO  kkm.UnitTests - End test

